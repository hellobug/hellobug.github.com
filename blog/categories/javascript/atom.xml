<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: javascript | Hello Bug~]]></title>
  <link href="http://hellobug.github.com/blog/categories/javascript/atom.xml" rel="self"/>
  <link href="http://hellobug.github.com/"/>
  <updated>2015-01-28T01:15:16+08:00</updated>
  <id>http://hellobug.github.com/</id>
  <author>
    <name><![CDATA[hellobug]]></name>
    <email><![CDATA[joy.xczhang+hellobug@gmail.com]]></email>
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[[AngularJS系列(5-2)] Directive - Compile vs. Link]]></title>
    <link href="http://hellobug.github.com/blog/angularjs-directive-2-compile-vs-link/"/>
    <updated>2013-08-14T20:35:00+08:00</updated>
    <id>http://hellobug.github.com/blog/angularjs-directive-2-compile-vs-link</id>
    <content type="html"><![CDATA[<p>还是先从栗子们看起~</p>

<p>如果我想实现这样一个功能，当一个input失去光标焦点时(blur)，执行一些语句，比如当输入用户名后，向后台发ajax请求查询用户名是否已经存在，好有及时的页面相应。</p>

<p>输入 <strong>hellobug</strong>   <br/>
<img src="/my-images/angularjs-directive-2-input-focus.png"></p>

<p>失去焦点后提示 <strong>hellobug</strong> 这个用户名已经存在  <br/>
<img src="/my-images/angularjs-directive-2-input-blur.png"></p>

<!-- more -->


<p>代码如下：
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>HTML </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;body</span> <span class="na">ng-controller=</span><span class="s">&quot;MainCtrl&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;pre&gt;&lt;code&gt;</span><span class="ni">&amp;lt;</span>lable<span class="ni">&amp;gt;</span>用户名:
</span><span class='line'>  <span class="ni">&amp;lt;</span>input type=&quot;text&quot; ng-model=&quot;username&quot; ng-blur=&quot;checkUsername()&quot; /<span class="ni">&amp;gt;</span>
</span><span class='line'>  <span class="ni">&amp;lt;</span>span style=&quot;color:red;&quot; ng-show=&quot;usernameAlreadyExist&quot;<span class="ni">&amp;gt;</span>用户名已经存在<span class="ni">&amp;lt;</span>/span<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>/lable<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="nt">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;&lt;/body&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>controller和directive的定义 </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s1">&#39;MainCtrl&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$scope</span><span class="p">.</span><span class="nx">checkUsername</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="c1">//send ajax to check on server</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">$scope</span><span class="p">.</span><span class="nx">username</span> <span class="o">===</span> <span class="s1">&#39;hellobug&#39;</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$scope</span><span class="p">.</span><span class="nx">usernameAlreadyExist</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">app</span><span class="p">.</span><span class="nx">directive</span><span class="p">(</span><span class="s1">&#39;ngBlur&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$document</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="nx">link</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;blur&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
</span><span class='line'>     <span class="nx">scope</span><span class="p">.</span><span class="nx">$apply</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">ngBlur</span><span class="p">);</span>
</span><span class='line'>  <span class="p">});</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>  <span class="p">}</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>在上面的例子里，directive返回对象里定义的<code>link</code>方法在blur事件触发时执行了scope上的<code>checkUsername()</code>方法。</p>

<p>如果是只有<code>link</code>方法，也可以简单的写成下面这种形式~直接返回<code>link</code>对应的function~</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>directive的简单写法 </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">directive</span><span class="p">(</span><span class="s1">&#39;ngBlur&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$document</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="kd">function</span><span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;blur&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">){</span>
</span><span class='line'>   <span class="nx">scope</span><span class="p">.</span><span class="nx">$apply</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">ngBlur</span><span class="p">);</span>
</span><span class='line'><span class="p">});</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>  <span class="p">};</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<hr />

<p>再来这样一个功能，我想让内容为<code>哈哈哈哈</code>的dom元素重复n遍，n是自定义的，以达到某种满屏大笑丧心病狂的效果 -_-，我知道<code>ng-repeat</code>就已经能干这事儿了，但是如果自己实现一下呢~</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>HTML </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;ul</span> <span class="na">repeater=</span><span class="s">&quot;20&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;li&gt;</span>哈哈哈哈<span class="nt">&lt;/li&gt;</span>
</span><span class='line'><span class="nt">&lt;/ul&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>directive的定义 </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">directive</span><span class="p">(</span><span class="s1">&#39;repeater&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$document</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="nx">restrict</span><span class="o">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span>
</span><span class='line'><span class="nx">compile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">element</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">template</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">children</span><span class="p">().</span><span class="nx">clone</span><span class="p">();</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&amp;</span><span class="nx">lt</span><span class="p">;</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">repeater</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">template</span><span class="p">.</span><span class="nx">clone</span><span class="p">());</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>  <span class="p">}</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>在上面例子的<code>compile</code>方法里，子元素被复制成了<code>repeater</code>制定的数量。</p>

<hr />

<p>什么时候用compile，什么时候用link呢，或者两者可不可以一起用呢？</p>

<p>先从directive是如何在angular手下生效的说起吧~</p>

<h2>编译三阶段：</h2>

<h3>1. 标准浏览器API转化</h3>

<p>将html转化成dom，所以自定义的html标签必须符合html的格式</p>

<h3>2. Angular compile</h3>

<p>搜索匹配directive，按照<code>priority</code>排序，并执行directive上的<code>compile</code>方法</p>

<h3>3. Angular link</h3>

<p>执行directive上的<code>link</code>方法，进行scope绑定及事件绑定</p>

<h2>为什么编译的过程要分成compile和link?</h2>

<p>简单的说就是为了解决性能问题，特别是那种model变化会影响dom结构变化的，而变化的结构还会有新的scope绑定及事件绑定，比如<code>ng-repeat</code></p>

<h2><code>compile</code>和<code>link</code>的形式</h2>

<h3>compile</h3>

<ul>
<li><code>function compile(element, attrs, transclude) { ... }</code></li>
<li>在compile阶段要执行的函数，返回的function就是link时要执行的function</li>
<li>常用参数为<code>element</code>和<code>attrs</code>，分别是dom元素和元素上的属性们，其它的以后细说</li>
<li>较少使用，因为大部分directive是处理dom元素的行为绑定，而不是改变它们</li>
</ul>


<h3>link</h3>

<ul>
<li><code>function link(scope, element, attrs, controller) { ... }</code></li>
<li>在link阶段要执行的函数，这个属性只有当compile属性没有设置时才生效</li>
<li>常用参数为<code>scope</code>，<code>element</code>和<code>attrs</code>，分别是当前元素所在的scope，dom元素和元素上的属性们，其它的以后细说</li>
<li>directive基本上都会有此函数，可以注册事件，并与scope相绑</li>
</ul>


<h2><code>compile</code>和<code>link</code>的使用时机</h2>

<h3>compile</h3>

<ul>
<li>想在dom渲染前对它进行变形，并且不需要scope参数</li>
<li>想在所有相同directive里共享某些方法，这时应该定义在compile里，性能会比较好</li>
<li>返回值就是link的function，这时就是共同使用的时候</li>
</ul>


<h3>link</h3>

<ul>
<li>对特定的元素注册事件</li>
<li>需要用到scope参数来实现dom元素的一些行为</li>
</ul>


<h2>最后~</h2>

<p>本节目所用示例可以猛戳<a href="http://embed.plnkr.co/41guX7lPUAccn2sWeObO/preview">这里</a>查看ho~</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[AngularJS系列(5-1)] Directive - 开场小介绍]]></title>
    <link href="http://hellobug.github.com/blog/angularjs-directive-1-basic-introduction/"/>
    <updated>2013-08-04T22:35:00+08:00</updated>
    <id>http://hellobug.github.com/blog/angularjs-directive-1-basic-introduction</id>
    <content type="html"><![CDATA[<p>Directive其实就是让html变得更强大的一种方法。它可以根据需求对dom变形，或注入行为。</p>

<p>觉得它很神秘么，其实一点儿也不神秘，只要开始使用AngularJS了，就一定在使用着Directive，比如我们在html上写的那些<code>ng-controller</code>，<code>ng-model</code>，<code>ng-show</code>等等都是AngularJS提供的Directive啊~</p>

<p>那到底内部是怎么实现的呢？或者如果觉得AngularJS内置提供的Directive不给力咋办？现在咱们就自己做一个试试看吧~</p>

<!-- more -->


<p><img src="/my-images/angularjs-directive-1-address-inputs.png"></p>

<p>先来个比较简单的需求，假如我们的应用经常要用到地址信息的输入选项，如果不自定义directive，html要写成这样~</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;address&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;label&gt;</span>
</span><span class='line'>        国家:<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">ng-model=</span><span class="s">&quot;country&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/label&gt;</span>
</span><span class='line'>    <span class="nt">&lt;label&gt;</span>
</span><span class='line'>        城市:<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">ng-model=</span><span class="s">&quot;city&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/label&gt;</span>
</span><span class='line'>    <span class="nt">&lt;label&gt;</span>
</span><span class='line'>        街道详情:<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">ng-model=</span><span class="s">&quot;address&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/label&gt;</span>
</span><span class='line'>    <span class="nt">&lt;label&gt;</span>
</span><span class='line'>        邮编:<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">ng-model=</span><span class="s">&quot;zipcode&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/label&gt;</span>
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>这样的代码可能要写多次，给维护也添加了复杂度。
如果自定义个地址的directive，代码如下：</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>之前的html </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">my-address</span><span class="nt">&gt;</span> <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>抽出来的html模板，名称为address.html </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;address&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;label&gt;</span>
</span><span class='line'>        国家:<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">ng-model=</span><span class="s">&quot;country&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/label&gt;</span>
</span><span class='line'>    <span class="nt">&lt;label&gt;</span>
</span><span class='line'>        城市:<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">ng-model=</span><span class="s">&quot;city&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/label&gt;</span>
</span><span class='line'>    <span class="nt">&lt;label&gt;</span>
</span><span class='line'>        街道详情:<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">ng-model=</span><span class="s">&quot;address&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/label&gt;</span>
</span><span class='line'>    <span class="nt">&lt;label&gt;</span>
</span><span class='line'>        邮编:<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">ng-model=</span><span class="s">&quot;zipcode&quot;</span> <span class="nt">/&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/label&gt;</span>
</span><span class='line'><span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>directive的定义 </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">directive</span><span class="p">(</span><span class="s2">&quot;myAddress&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="p">{</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="nx">restrict</span><span class="o">:</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nx">templateUrl</span><span class="o">:</span> <span class="s2">&quot;address.html&quot;</span><span class="p">,</span>
</span><span class='line'><span class="nx">replace</span><span class="o">:</span> <span class="kc">true</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>  <span class="p">}</span>
</span><span class='line'><span class="p">})</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h2>命名</h2>

<p>可能有人注意到了，在html里标签上定义的属性叫<code>my-address</code>，可是在js里定义directive时写的名字是<code>myAddress</code>，这能对应上么？</p>

<p>其实是可以的，不仅如此，下列格式都可以识别出来~</p>

<ul>
<li>my:address</li>
<li>my-address (推荐)</li>
<li>my_address</li>
<li>x-my-address</li>
<li>data-my-address</li>
</ul>


<p>但是由于html不区分大小写和标准写法是用中横线<code>-</code>的特性，比较推荐<code>my-address</code>这种写法，既简洁又遵循html的规则。</p>

<h2>声明形式限制</h2>

<p><code>restrict: "A"</code> 这一句表示对directive声明形式的限制，一共有四种：</p>

<ul>
<li><code>E</code>: <code>&lt;my-address&gt;&lt;/my-address&gt;</code> Element Name 标签名</li>
<li><code>A</code>: <code>&lt;div my-address="exp"&gt;&lt;/div&gt;</code> Attribute 属性名（默认值）</li>
<li><code>C</code>: <code>&lt;div class="my-address: exp;"&gt;&lt;/div&gt;</code> Class 类名</li>
<li><code>M</code>: <code>&lt;!-- directive: my-address exp --&gt;</code> Comment 注释</li>
</ul>


<p>其实不写也可以，因为如果不写，默认就是<code>restrict: "A"</code></p>

<p>如果想支持多项，可以写成<code>restrict: "EA"</code>，这样就又支持标签的写法，又支持属性的写法</p>

<p>虽然一共有四种可以选择，但后两种并不推荐~</p>

<ul>
<li>类应该更多的是与样式相关，而且将directive名混杂在一群类名里，可读性也不好</li>
<li>注释就更不可靠了，将重要的逻辑写在注释里，太容易被忽略了</li>
</ul>


<h2>Html内容模板指定</h2>

<p><code>templateUrl: "address.html"</code>指定了模板的Url路径，如果想直接写html内容也可以用：<br/>
<code>template: "&lt;div class='address'&gt;blabla&lt;/div&gt;"</code></p>

<p>下面的<code>replace: true</code>表示模板html内容是否会替换<code>&lt;div my-address&gt;&lt;/div&gt;</code>，还是插入到<code>&lt;div my-address&gt;&lt;/div&gt;</code>元素里，默认是<code>false</code></p>

<h2>最后</h2>

<p>这样一个简单的directive就写好了，其实如果只是想抽html模板的话，还可以用<code>ng-include</code>，相当上上面例子里<code>replace:false</code>的效果~</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>使用ng-include的版本 </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>//注意这里是单引号套着双引号，外面一层引号是表示标签属性的值，里面一层引号表示直接给的模板名称，因为这里也可以通过表达式的返回值来取<span class="nt">&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;div</span> <span class="na">ng-include=</span><span class="s">&#39;&quot;address.html&quot;&#39;</span><span class="nt">&gt;</span> <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>貌似更简单。。。那前面说那么多干嘛？！<br/>
这不是为了熟悉directive嘛~ -_-|||</p>

<p>想自己动手试试，就猛戳<a href="http://embed.plnkr.co/kwfzsM3s9bab9YIewzQj/preview">这里</a>吧~</p>

<p>其实directive的世界搭滴恨(小纪念一下在西安悠哉的小日子)，下集待续。。。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[AngularJS系列(4)] 那伤不起的provider们啊~ (provider, value, constant, service, factory, decorator)]]></title>
    <link href="http://hellobug.github.com/blog/angularjs-providers/"/>
    <updated>2013-04-23T22:35:00+08:00</updated>
    <id>http://hellobug.github.com/blog/angularjs-providers</id>
    <content type="html"><![CDATA[<p>用AngularJS做项目，但凡用过什么service啊，factory啊，provider啊，开始的时候晕没晕？！晕没晕？！感觉干的事儿都差不多啊，到底用哪个啊？！别告诉我你们几个就是为了跟我炫耀兄弟多！！<img src="/my-images/emotions/xianzhuozi.jpg"></p>

<p>好吧。。。也许是我的问题，脑仁儿确实不够大，反正我是晕的直挠墙~</p>

<p>那到底什么时候该请他们谁出场啊？</p>

<p>经过挠墙之后挠官网文档挠google挠源码挠例子试验，终于让我把他们的区别给挠出来了！（得意的笑～～）</p>

<p>首先，<code>provider</code>, <code>value</code>, <code>constant</code>, <code>service</code>, <code>factory</code>他们都是provider！（<code>decorator</code>小朋友先搬个小板凳坐在边上等会儿，现在还没轮到你出场哈~）</p>

<p>provider是干啥的？</p>

<!-- more -->


<p>provider可以为应用提供通用的服务，形式可以是常量，也可以是对象。</p>

<p>比如我们在controller里常用的<code>$http</code>就是AngularJS框架提供的provider～</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">myApp</span><span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="err">‘</span><span class="nx">MainController</span><span class="err">&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">$http</span><span class="p">)</span> <span class="p">{</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="nx">$http</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="err">…</span><span class="p">)</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>在上面的代码里，就可以直接使用<code>$http</code>包好的各种功能了～</p>

<h1>provider</h1>

<p>那我们自己想定制一个provider，怎么写呢～</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">//定义:</span>
</span><span class='line'><span class="nx">$provide</span><span class="p">.</span><span class="nx">provider</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="p">{</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="nx">start</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>
</span><span class='line'><span class="nx">$get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">start</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">});</span>
</span><span class='line'><span class="c1">//或</span>
</span><span class='line'><span class="nx">$provide</span><span class="p">.</span><span class="nx">provider</span><span class="p">(</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$filterProvider</span><span class="p">){</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="k">this</span><span class="p">.</span><span class="nx">start</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
</span><span class='line'><span class="k">this</span><span class="p">.</span><span class="nx">$get</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">start</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">});</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="c1">//调用:</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s1">&#39;MainCtrl&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">age</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$scope</span><span class="p">.</span><span class="nx">age</span> <span class="o">=</span> <span class="nx">age</span><span class="p">;</span> <span class="c1">//12</span>
</span><span class='line'><span class="p">});</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>provider的基本原则就是通过实现<code>$get</code>方法来在应用中注入单例，使用的时候拿到的<code>age</code>就是<code>$get</code>执行后的结果。
上面例子中的两种定义方法都可以～</p>

<h1>factory</h1>

<p>大哥<code>provider</code>每次出场太繁琐了，如果我就想定义个<code>$get</code>，没别的乱七八糟的呢？这时候该二哥<code>factory</code>出场了～</p>

<p>（脑补背景音乐：葫芦娃～葫芦娃～一根藤上七朵花～[我说你够了啊！>_&lt;]）</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$provide</span><span class="p">.</span><span class="nx">provider</span><span class="p">(</span><span class="s1">&#39;myDate&#39;</span><span class="p">,</span> <span class="p">{</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="nx">$get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">});</span>
</span><span class='line'><span class="c1">//可以写成</span>
</span><span class='line'><span class="nx">$provide</span><span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="s1">&#39;myDate&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">});</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="c1">//调用:</span>
</span><span class='line'><span class="nx">app</span><span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s1">&#39;MainCtrl&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">myDate</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">$scope</span><span class="p">.</span><span class="nx">myDate</span> <span class="o">=</span> <span class="nx">myDate</span><span class="p">;</span> <span class="c1">//current date</span>
</span><span class='line'><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>直接第二个参数就是$get要对应的函数实现，代码简单了很多有没有？！</p>

<h1>service</h1>

<p>这时候我又来劲儿了，我不仅就想定义个<code>$get</code>，里面我还就返回个new出来的已有js类，三哥<code>service</code>闪亮登场～</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$provide</span><span class="p">.</span><span class="nx">provider</span><span class="p">(</span><span class="s1">&#39;myDate&#39;</span><span class="p">,</span> <span class="p">{</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="nx">$get</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">});</span>
</span><span class='line'><span class="c1">//可以写成</span>
</span><span class='line'><span class="nx">$provide</span><span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="s1">&#39;myDate&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="k">return</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">});</span>
</span><span class='line'><span class="c1">//可以写成</span>
</span><span class='line'><span class="nx">$provide</span><span class="p">.</span><span class="nx">service</span><span class="p">(</span><span class="s1">&#39;myDate&#39;</span><span class="p">,</span> <span class="nb">Date</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>对于这种需求，代码更简洁了是不是～～</p>

<h1>value vs. constant</h1>

<p>更直接的需求来了，我只想定义个<code>$get</code>，而且就返回个常量～</p>

<p>这时候<code>value</code>和<code>constant</code>都可以做到～</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$provide</span><span class="p">.</span><span class="nx">value</span><span class="p">(</span><span class="s1">&#39;pageCount&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
</span><span class='line'><span class="nx">$provide</span><span class="p">.</span><span class="nx">constant</span><span class="p">(</span><span class="s1">&#39;pageCount&#39;</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>兄弟俩功能一样？双胞胎？那怎么可能～</p>

<p>介绍区别前，先得把之前坐小板凳等着的<code>decorator</code>叫出来～终于该出场了～</p>

<h3>区别一：<code>value</code>可以被修改，<code>constant</code>一旦声明无法被修改</h3>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$provide</span><span class="p">.</span><span class="nx">decorator</span><span class="p">(</span><span class="s1">&#39;pageCount&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$delegate</span><span class="p">)</span> <span class="p">{</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="k">return</span> <span class="nx">$delegate</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><code>decorator</code>可以用来修改（修饰）已定义的provider们，除了<code>constant</code>～</p>

<h3>区别二：<code>value</code>不可在<code>config</code>里注入，<code>constant</code>可以</h3>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">myApp</span><span class="p">.</span><span class="nx">config</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">pageCount</span><span class="p">){</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="c1">//可以得到constant定义的&#39;pageCount&#39;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>关于<code>config</code>，之后会专门介绍～</p>

<h2>通过底层实现代码看关系～</h2>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="kd">function</span> <span class="nx">provider</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">provider_</span><span class="p">)</span> <span class="p">{</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="k">if</span> <span class="p">(</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">provider_</span><span class="p">))</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">provider_</span> <span class="o">=</span> <span class="nx">providerInjector</span><span class="p">.</span><span class="nx">instantiate</span><span class="p">(</span><span class="nx">provider_</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">provider_</span><span class="p">.</span><span class="nx">$get</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">throw</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Provider &#39;</span> <span class="o">+</span> <span class="nx">name</span> <span class="o">+</span> <span class="s1">&#39; must define $get factory method.&#39;</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">return</span> <span class="nx">providerCache</span><span class="p">[</span><span class="nx">name</span> <span class="o">+</span> <span class="nx">providerSuffix</span><span class="p">]</span> <span class="o">=</span> <span class="nx">provider_</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="kd">function</span> <span class="nx">factory</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">factoryFn</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">provider</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="p">{</span> <span class="nx">$get</span><span class="o">:</span> <span class="nx">factoryFn</span> <span class="p">});</span> <span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="kd">function</span> <span class="nx">service</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">constructor</span><span class="p">)</span> <span class="p">{</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="k">return</span> <span class="nx">factory</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;$injector&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$injector</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">$injector</span><span class="p">.</span><span class="nx">instantiate</span><span class="p">(</span><span class="nx">constructor</span><span class="p">);</span>
</span><span class='line'><span class="p">}]);</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="kd">function</span> <span class="nx">value</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">factory</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">valueFn</span><span class="p">(</span><span class="nx">value</span><span class="p">));</span> <span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="kd">function</span> <span class="nx">constant</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="nx">providerCache</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
</span><span class='line'><span class="nx">instanceCache</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="kd">function</span> <span class="nx">decorator</span><span class="p">(</span><span class="nx">serviceName</span><span class="p">,</span> <span class="nx">decorFn</span><span class="p">)</span> <span class="p">{</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="kd">var</span> <span class="nx">origProvider</span> <span class="o">=</span> <span class="nx">providerInjector</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">serviceName</span> <span class="o">+</span> <span class="nx">providerSuffix</span><span class="p">),</span>
</span><span class='line'>    <span class="nx">orig$get</span> <span class="o">=</span> <span class="nx">origProvider</span><span class="p">.</span><span class="nx">$get</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="nx">origProvider</span><span class="p">.</span><span class="nx">$get</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">origInstance</span> <span class="o">=</span> <span class="nx">instanceInjector</span><span class="p">.</span><span class="nx">invoke</span><span class="p">(</span><span class="nx">orig$get</span><span class="p">,</span> <span class="nx">origProvider</span><span class="p">);</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">instanceInjector</span><span class="p">.</span><span class="nx">invoke</span><span class="p">(</span><span class="nx">decorFn</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="p">{</span><span class="nx">$delegate</span><span class="o">:</span> <span class="nx">origInstance</span><span class="p">});</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>从上面的代码可以看出之前介绍的每种provider的特点，<code>decorator</code>比较特殊，不算，除了<code>constant</code>，另外几个最终调用的都是<code>provider</code>～</p>

<h2>最后再总结一下provider哥儿几个的优点～</h2>

<h4>1. 为应用提供通用的服务，形式可以是常量或对象</h4>

<h4>2. 便于模块化</h4>

<h4>3. 便于单元测试</h4>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[AngularJS系列(3)] View-Model双向绑定背后的故事~]]></title>
    <link href="http://hellobug.github.com/blog/angularjs-two-ways-binding/"/>
    <updated>2013-03-27T22:13:00+08:00</updated>
    <id>http://hellobug.github.com/blog/angularjs-two-ways-binding</id>
    <content type="html"><![CDATA[<p>剧情开始之前，先介绍一下重要背景~三个概念~</p>

<ul>
<li><strong>Dirty Checking</strong> – AngularJS内部比较value现在的值和之前的值，如果发生了改变，就触发change事件。</li>
<li><strong>Digest</strong> – 执行<code>Dirty Checking</code>的机制，由$digest()触发。</li>
<li><strong>Apply</strong> – 当dom事件在AngularJS机制外被触发时，需要通知AngularJS进行<code>Digest</code>。由<code>$apply()</code>触发。</li>
</ul>


<!-- more -->


<h1>$digest()</h1>

<p><img src="/my-images/angularjs-2-ways-1-1.png"></p>

<p>Digest就像AngularJS的心跳一样~ <br/>
它每次跳动的时候会触发所属的scope和其所有子scope的dirty checking，dirty checking又会触发$watch()（马上会介绍<code>$watch()</code>），整个Angular双向绑定机制就活了起来，页面也会随之更新~ <br/>
注意：不建议直接调用<code>$scope.$digest()</code>，而应该使用<code>$scope.$apply()</code>，原因一会儿细说~ <br/>
<strong>（曾经在这里写过Digest是每50ms“跳动”一次，网上很多文章也是这么写的，其实这样的说法并不全面严谨，原因在这个文章后面会细细说明~）</strong></p>

<h1>$watch()</h1>

<p><img src="/my-images/angularjs-2-ways-1-2.png"></p>

<p>每个成功的digest背后都有一群好watch~</p>

<ul>
<li>在digest执行时，如果<code>watch</code>观察的value与上次执行时不一样时，就会被触发</li>
<li>AngularJS内部的watch实现了页面随model的及时更新，其实我们每创建一个model，比如<code></code>，AngularJS都会在后台悄悄的为这个model创建一个watch去监听它的变化</li>
<li>也可手动调用~ <br/>
  <strong>参数1</strong>：待观察的value <br/>
  <strong>参数2</strong>：value改变时想执行的操作，两个参数分别是改变前后的值 <br/>
  <strong>参数3</strong>：默认是<code>false</code>，使用的是JavaScript本身提供的比较方式，<code>true</code>表示比较的是真实的值，会有这个区别是由于JavaScript里对对象的比较是比较的引用地址（可参考<a href="/blog/javascript-variable-assignment/" title="[JS] 让人犯晕的Javascript变量赋值">这篇blog</a>），所以如果watch的是一个对象类型的数据，即使重新赋值了相同的内容，也会触发change事件，比如watch的变量对应的值是一个数组<code>[1, 2]</code>，如果再次给这个变量赋值<code>[1, 2]</code>，是会触发<code>watch</code>里面的参数2函数的，而大部分时候，对于相同的内容，我们不希望执行<code>watch</code>里的操作，所以可以把第三个参数设置成true，这个时候就会调用<code>angular.equals</code>来进行比较，<code>angular.equals</code>是会比较对象里每一个属性的值是否一样的。当然，如果watch的是五种基本类型（Undefined, Null, Boolean, Number和String）就不需要设置了，因为它们不会发生这种值相同却不相等的情况。</li>
</ul>


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">$scope</span><span class="p">.</span><span class="nx">$watch</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">newValue</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">)</span> <span class="p">{</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="cm">/* Do something here */</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">},</span> <span class="kc">true</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<h1>$apply()</h1>

<p><img src="/my-images/angularjs-2-ways-1-3.png"></p>

<p>我们可以把<code>apply</code>看成个给AngularJS送信的~ <br/>
<code>$scope.$apply()</code>会触发digest，如果有一个function参数，function会先被执行，再digest~</p>

<p><strong>应该啥时候自己调用呢？</strong> <br/>
当dom事件在AngularJS机制外被触发时~</p>

<p><strong>什么样的情况算机制外呢？</strong><br/>
喂，jQuery，你就别看别人了~！！</p>

<p>现在到这个问题了，<strong>为啥推荐使用<code>$apply</code>而不是<code>$digest</code>？</strong>  <br/>
因为<code>$apply</code>其实不能把信直接送给<code>$digest</code>，之间还有<code>$eval</code>门卫把关，如果<code>$apply</code>带的表达式不合法，<code>$eval</code>会把错误送交<code>$exceptionHandler service</code>，合法才触发digest，所以更安全~</p>

<p><strong>举个栗子~</strong></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">ng-blur=</span><span class="s">&quot;closeDialog()&quot;</span> <span class="nt">/&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">myApp</span><span class="p">.</span><span class="nx">directive</span><span class="p">(</span><span class="s1">&#39;ngBlur&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span> <span class="k">return</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">restrict</span><span class="o">:</span><span class="s1">&#39;A&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="nx">link</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">scope</span><span class="p">,</span> <span class="nx">element</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>           <span class="nx">$</span><span class="p">(</span><span class="nx">elelment</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;blur&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>                <span class="nx">scope</span><span class="p">.</span><span class="nx">$apply</span><span class="p">(</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">ngBlur</span><span class="p">);</span>
</span><span class='line'>           <span class="p">});</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'> <span class="p">};</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">});</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>jQuery对blur事件的绑定就属于AngularJS机制外触发，必须使用<code>$apply</code>才能生效。（新版本的AngularJS已经提供<code>ng-blur</code>这个directive了，这里作为例子看一下就好~）</p>

<h1>再细细说一下<code>$digest</code>和<code>&amp;apply</code></h1>

<p>通过刚才的描述，我们已经知道了Angular内部会自动为页面显示的model创建watcher，然后我们也可以自定义一些watcher去监听model，然后在model变化时做一些自己想做的事情~ <br/>
然后<code>$watch()</code>是由谁来触发的呢？就是<code>$digest()</code>【恭喜我自己都会抢答了。。。】 <br/>
那么问题来了，咳咳，<strong>$digest()是由谁触发的呢？</strong> <br/>
其实有两种角色：</p>

<ol>
<li>angular提供的directive之类的，比如你用到了angular的<code>ng-click</code>这个directive，在它对应的函数或表达式里你改变了某个model的值，这时候Angular觉察到“我擦不好有变动~”，就会自动触发一个<code>$scope.$apply()</code>，而这个apply又会调用<code>$rootScope.$digest()</code>，于是一轮由顶至下的dirty checking就轰轰烈烈的荡漾开了~页面也会随之更新了~</li>
<li>Angular体制外对model修改后手动调用了<code>$apply</code>，也会调用<code>$rootScope.$digest()</code>，刚刚介绍过~</li>
</ol>


<p>然后问题又来了，<strong>就这么一轮dirty checking也好意思叫自己心跳？</strong>  <br/>
-_-确实勉强了点儿，可是就一轮儿多省事啊，为啥不行呢，回想一下<code>$watch</code>方法，我们在监听model改变的时候可以传入一个回调函数，如果我们在这个回调函数里又改变了其它model的值怎么办。。。不怕，Angular也想到了，所以它会一遍一遍的由顶至下的dirty checking，直到所有的model都没有改动了，至少为两轮，但是这样也有问题啊，万一有什么死循环或者过多的互相修改，这性能多差啊，得循环到啥时候去啊，没完没了了怎么办？没关系！Angular也想到了，所以设置了一个默认值为10的TTL（Time to Live），简单的说就是我就给你循环十次，即使循环到第十次model还有不一样，爷也不陪你玩儿了~</p>

<h1>Performance</h1>

<p>下面开始说性能了，动不动就循环个2到10次，受不受得了呢？</p>

<p>AngularJS的创建者曾经在stackoverflow上回过一篇巨火的<a href="http://stackoverflow.com/questions/9682092/databinding-in-angularjs?answertab=votes#tab-top">答复</a>，里面提到了他做了一个实验，他在一个页面搞了10,000个watcher，在流行的浏览器里dirty checking用了不到6ms，而巨慢的IE8也只用了40ms，他也列出了下面的科学研究结果：</p>

<ul>
<li><strong>人对变化的反应是慢的</strong>：任何比50ms还快的变化都是不可被察觉的~</li>
<li><strong>人对信息的处理能力是有限的</strong>：在一页处理2000条信息已经算是极限了，再多的信息量往一页上堆只能说是不好的设计了，而且人也无法处理了~</li>
</ul>


<p>所以问题就演变为：<strong>我们能不能在50ms里做2000次比较呢？</strong> <br/>
以现在的技术来说，即使是很慢的浏览器也没问题的。当然如果每个比较都写的特别复杂就另说了~而且在watch里过多的去改变其它的model值也绝不是个好习惯啊，所以当遇到这种情况的时候，就是一种代码的坏味道了，看看是不是可以重构简化一下啦~</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[AngularJS系列(2)] Scope什么的~]]></title>
    <link href="http://hellobug.github.com/blog/angularjs-scope/"/>
    <updated>2013-03-15T20:47:00+08:00</updated>
    <id>http://hellobug.github.com/blog/angularjs-scope</id>
    <content type="html"><![CDATA[<p>Scope是AngularJS里的一个很重要的概念，简单的说它就是用来保存AngularJS Model们的对象，是Model们温暖的小家～</p>

<p>那这个小家是什么时候造的呢？</p>

<!-- more -->


<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html</span> <span class="na">ng-app=</span><span class="s">&quot;mainApp&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>我们知道，<code>ng-app</code>是一个应用启动AngularJS的入口点，在这里也会创建一个root scope，在controller里可以通过<code>$rootScope</code>调到，每个应用只能有一个root scope（当然了～root嘛～），但它会有多个child scope，那啥时候会创建child scope呢？</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html</span> <span class="na">ng-app=</span><span class="s">&quot;mainApp&quot;</span><span class="nt">&gt;&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;pre&gt;&lt;code&gt;</span><span class="ni">&amp;lt;</span>body ng-controller=&quot;MainCtrl&quot;<span class="ni">&amp;gt;</span>
</span><span class='line'>    <span class="ni">&amp;lt;</span>div ng-controller=&quot;SubCtrl&quot; ng-include src=&quot; &#39;template.html&#39; &quot;<span class="ni">&amp;gt;</span>
</span><span class='line'>    <span class="ni">&amp;lt;</span>/div<span class="ni">&amp;gt;</span>
</span><span class='line'>    <span class="ni">&amp;lt;</span>ul<span class="ni">&amp;gt;</span>
</span><span class='line'>        <span class="ni">&amp;lt;</span>li ng-repeat=&quot;item in items&quot;<span class="ni">&amp;gt;</span>{{item.name}}<span class="ni">&amp;lt;</span>/li<span class="ni">&amp;gt;</span>
</span><span class='line'>    <span class="ni">&amp;lt;</span>/ul<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="ni">&amp;lt;</span>/body<span class="ni">&amp;gt;</span>
</span><span class='line'><span class="nt">&lt;/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nt">&lt;p&gt;&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>在上面的例子里，<code>ng-controller</code> <code>ng-include</code> <code>ng-repeat</code>都创建了新的child scope（<code>ng-repeat</code>是对每一个重复的元素都创建了新的child scope），他们之间的父子关系是这样的：</p>

<p><img src="/my-images/angularjs-scope-1-1.png"></p>

<p>包含关系即是他们的父子关系，子scope是可以访问父scope上绑定的所有model和function的。</p>

<p>AngularJS会给scope对应的dom添加叫ng-scope的class，如果我们给自己的应用加这样一个css~
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='css'><span class='line'><span class="nc">.ng-scope</span> <span class="p">{</span><span class="k">border</span><span class="o">:</span> <span class="m">2px</span> <span class="k">dotted</span> <span class="nb">red</span><span class="p">;}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
通过红色的虚线边框我们也可以看出来大概scope的范围，但注意，并不是所有的ng-scope都是新的scope，有些ng-scope类名对应的dom共享的是同一个scope。</p>

<p>细心的童鞋可能注意到，<code>ng-controller="SubCtrl"</code>和<code>ng-include</code>放在同一个div上了，为啥<code>ng-controller="SubCtrl"</code>就是爸爸，<code>ng-include</code>就是儿子呢？ <br/>
这个没啥特别的原因，<code>ng-controller</code>在AngularJS底层代码里实现的比较靠前而已，与在div上标明的顺序无关，但是这时会发生一个问题：</p>

<p>假如在<code>ng-include</code>对应的<code>template.html</code>里有这样的代码：
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>template.html </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;text&quot;</span> <span class="na">ng-model=</span><span class="s">&quot;lastName&quot;</span> <span class="nt">&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>我们会发现，在<code>ng-controller="SubCtrl"</code>这个controller里是取不到<code>lastName</code>的值的。</p>

<p>原因是这样的~ <br/>
我们假设<code>ng-controller="SubCtrl"</code>对应的是<strong>Scope A</strong>，<code>ng-include</code>对应的是<strong>Scope B</strong>~</p>

<ol>
<li><code>ng-include</code>创建的<strong>Scope B</strong>是<code>ng-controller</code>创建的<strong>Scope A</strong>的子scope，所以在<code>template.html</code>里可以访问<strong>Scope A</strong>的model和function。</li>
<li>在<code>template.html</code>里用<code>ng-model</code>绑定的model，是存放在<strong>Scope B</strong>上的，<strong>Scope A</strong>是拿不到的，即使model同名。</li>
</ol>


<p>解决方案：</p>

<ul>
<li>直接对<strong>Scope A</strong>的model绑定成员对象，如<code>ng-model="user.lastName"</code></li>
<li>或在<code>template.html</code>使用<code>ng-model</code>绑定model时，加上<code>$parent</code>（取父scope），如：<code>ng-model="$parent.lastName"</code>，这样info就绑定在<strong>Scope A</strong>上了</li>
</ul>


<p>比较推荐第一种方式，因为第一种抽象出了对象，比起第二种所有的model都直接绑在$scope上来，封装的更好~</p>

<p><a href="http://docs.angularjs.org/guide/scope">这里是官方Scope介绍~</a></p>
]]></content>
  </entry>
  
</feed>
